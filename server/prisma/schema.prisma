// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Bảng User - Người dùng
model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  password      String
  name          String
  phone         String?   @unique
  dateOfBirth   DateTime?
  role          UserRole  @default(CUSTOMER)
  isActive      Boolean   @default(true)
  isDeleted     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  addresses     Address[]
  orders        Order[]
  reviews       Review[]
  cart          Cart?
  avatar  Media? @relation("AvatarImage" ) 
}

enum UserRole {
  CUSTOMER
  ADMIN
}

// Bảng Address - Địa chỉ giao hàng
model Address {
  id            Int       @id @default(autoincrement())
  userId        Int
  fullName      String
  phone         String
  address       String
  ward          String
  district      String
  province      String
  isDefault     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders        Order[]
}

// Bảng Category - Danh mục sản phẩm
model Category {
  id            Int                @id @default(autoincrement())
  name          String
  slug          String             @unique
  description   String?
  isActive      Boolean            @default(true)
  isDeleted     Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  
  productCategories ProductCategory[]
  image        Media? @relation("CategoryImage") 
}

// Bảng Product - Sản phẩm
model Product {
  id            Int                @id @default(autoincrement())
  name          String
  slug          String             @unique
  description   String?
  material      String?
  brand         String?
  isActive      Boolean            @default(true)
  isDeleted     Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  
  variants      ProductVariant[]
  productCategories ProductCategory[]
  reviews       Review[]
  images         Media[] @relation("ProductImages")
}

// Bảng trung gian Product - Category (Many-to-Many)
model ProductCategory {
  productId     Int
  categoryId    Int
  createdAt     DateTime  @default(now())
  
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  category      Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@id([productId, categoryId])
}

// Bảng ProductVariant - Biến thể sản phẩm
model ProductVariant {
  id            Int       @id @default(autoincrement())
  productId     Int
  sku           String    @unique
  name          String    // Tên biến thể: "Đỏ - M", "Xanh - L", "38", "Vàng kim"
  price         Decimal   @db.Decimal(10, 2)
  comparePrice  Decimal?  @db.Decimal(10, 2)
  stock         Int       @default(0)
  isActive      Boolean   @default(true)
  isDeleted     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributes    VariantAttribute[]
  cartItems     CartItem[]
  orderItems    OrderItem[]
  images         Media[] @relation("VariantImages")
}

// Bảng VariantAttribute - Thuộc tính động của biến thể
model VariantAttribute {
  id            Int       @id @default(autoincrement())
  variantId     Int
  name          String    // Tên thuộc tính: "Màu sắc", "Kích thước", "Chất liệu", "Kiểu dáng"
  value         String    // Giá trị: "Đỏ", "M", "Cotton", "Slim fit"
  createdAt     DateTime  @default(now())
  
  variant       ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  @@unique([variantId, name])
}

// Bảng Cart - Giỏ hàng
model Cart {
  id            Int       @id @default(autoincrement())
  userId        Int       @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         CartItem[]
}

// Bảng CartItem - Sản phẩm trong giỏ hàng
model CartItem {
  id            Int       @id @default(autoincrement())
  cartId        Int
  variantId     Int
  quantity      Int       @default(1)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  cart          Cart      @relation(fields: [cartId], references: [id], onDelete: Cascade)
  variant       ProductVariant @relation(fields: [variantId], references: [id])
  
  @@unique([cartId, variantId])
}

// Bảng Order - Đơn hàng
model Order {
  id            Int       @id @default(autoincrement())
  orderNumber   String    @unique
  userId        Int
  addressId     Int
  status        OrderStatus @default(PENDING)
  subtotal      Decimal   @db.Decimal(10, 2)
  shippingFee   Decimal   @db.Decimal(10, 2) @default(0)
  discount      Decimal   @db.Decimal(10, 2) @default(0)
  total         Decimal   @db.Decimal(10, 2)
  paymentMethod PaymentMethod
  paymentStatus PaymentStatus @default(UNPAID)
  note          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id])
  address       Address   @relation(fields: [addressId], references: [id])
  items         OrderItem[]
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPING
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  COD
  BANK_TRANSFER
  MOMO
  VNPAY
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

// Bảng OrderItem - Sản phẩm trong đơn hàng
model OrderItem {
  id            Int       @id @default(autoincrement())
  orderId       Int
  variantId     Int
  quantity      Int
  price         Decimal   @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())
  
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant       ProductVariant @relation(fields: [variantId], references: [id])
}

// Bảng Review - Đánh giá sản phẩm
model Review {
  id            Int       @id @default(autoincrement())
  productId     Int
  userId        Int
  rating        Int
  comment       String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id])
  images         Media[]   @relation("ReviewImages")
  
  @@unique([productId, userId])
}

// Bảng Media - Quản lý ảnh từ Cloudinary
model Media {
  id            String    @id @default(uuid())
  url           String    // secure_url từ Cloudinary
  publicId      String    // cloudinary public_id để xóa ảnh
  width         Int?
  height        Int?
  format        String?   // jpg, png, webp, etc.
  resourceType  String    @default("image") // image, video, raw
  
  // Quan hệ với các model khác
  productId     Int?
  variantId     Int?
  userId        Int?    @unique
  reviewId      Int?
  categoryId    Int?    @unique
  
  createdAt     DateTime  @default(now())
  
  product       Product?  @relation("ProductImages",fields: [productId], references: [id], onDelete: Cascade)
  variant       ProductVariant? @relation("VariantImages",fields: [variantId], references: [id], onDelete: Cascade)
  review        Review?   @relation("ReviewImages",fields: [reviewId], references: [id], onDelete: Cascade)
  user          User?     @relation("AvatarImage", fields: [userId], references: [id], onDelete: Cascade)
  category      Category? @relation("CategoryImage", fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@index([productId])
  @@index([variantId])
  @@index([userId])
  @@index([reviewId])
  @@index([categoryId])
}
